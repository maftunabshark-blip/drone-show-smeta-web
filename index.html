<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Drone Show Smeta • Web</title>

  <link rel="icon" href="./apple-touch-icon.ico">
  <link rel="apple-touch-icon" href="./apple-touch-icon.png">

  <style>
    :root { --card:#fff; --muted:#64748b; --brand:#111827; --border:#e5e7eb; }
    *{box-sizing:border-box} body{margin:0;font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial;background:#f5f7fb}
    .wrap{max-width:1100px;margin:32px auto;padding:0 16px}
    .top{display:flex;align-items:center;gap:12px}
    h1{font-size:26px;margin:0}
    select.lang{margin-left:auto;padding:8px 10px;border:1px solid var(--border);border-radius:10px;background:#fff}

    .grid{display:grid;grid-template-columns:1fr 1fr;gap:24px;margin-top:18px}
    .card{background:var(--card);border-radius:18px;box-shadow:0 10px 30px #0f172a18;padding:24px}
    .section-title{margin:0 0 8px;font-weight:700;color:var(--brand)}
    label{display:block;font-size:14px;color:var(--muted);margin:12px 0 6px}
    input{width:100%;padding:12px 14px;border:1px solid var(--border);border-radius:10px;font-size:16px;background:#fff}
    .row{display:flex;gap:12px;margin-top:16px;flex-wrap:wrap}
    button{padding:12px 16px;border:0;border-radius:12px;background:#1f2937;color:#fff;font-weight:600;cursor:pointer}
    button.secondary{background:#0f172a20;color:#0f172a}
    .note{margin-top:12px;color:#6b7280;font-size:14px}
    .total h2{font-size:40px;margin:6px 0}
    .logoBox{margin-top:14px;display:flex;align-items:center;gap:10px}
    .logoBox img{height:54px;width:auto;display:block}
    .status{margin-top:10px;font-size:14px}
    .ok{color:#15803d}.err{color:#b91c1c}
    @media (max-width:860px){ .grid{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <h1 id="t_app">Drone Show Smeta • <span class="muted">Web</span></h1>
      <select class="lang" id="langSel" aria-label="Language">
        <option value="uz">O‘zbekcha</option>
        <option value="ru">Русский</option>
        <option value="en">English</option>
      </select>
    </div>

    <div class="grid">
      <!-- Chap panel -->
      <div class="card">
        <h2 class="section-title" id="t_inputs">Kiritmalar</h2>

        <label for="v4" id="t_v4">Dron V4 (dona)</label>
        <input id="v4" type="number" min="0" step="1" value="1000">

        <label for="y2" id="t_y2">Dron Y2 (dona)</label>
        <input id="y2" type="number" min="0" step="1" value="100">

        <label for="fig" id="t_fig">Figuralar soni</label>
        <input id="fig" type="number" min="1" step="1" value="1">

        <label for="price" id="t_price">Narx (USD / dron / figura)</label>
        <input id="price" type="number" min="0" step="0.01" value="70">

        <div class="row">
          <button id="btnRefresh">CBU kursini yangilash</button>
          <button id="btnClear" class="secondary">Tozalash</button>
        </div>

        <div class="logoBox">
          <img src="./icons/geo_logo.png?v=3" alt="GEO Innovation Centre logotipi">
          <div class="note" id="t_logoText">GEO Innovation Centre</div>
        </div>

        <div class="note" id="rateLbl">Kurs: USD→UZS: —</div>
        <div class="status" id="statusLbl"></div>
      </div>

      <!-- O‘ng panel -->
      <div class="card total">
        <h2 class="section-title" id="t_total_usd">Jami (USD):</h2>
        <h2 id="usdTotal">$ 0.00</h2>
        <hr style="border:none;border-top:1px solid #e5e7eb;margin:18px 0">
        <h2 class="section-title" id="t_total_uzs">Jami (UZS):</h2>
        <h2 id="uzsTotal">0 so‘m</h2>
        <div class="note" id="t_formula">Formula: (V4 + Y2) × narx × figuralar.</div>
      </div>
    </div>
  </div>

<script>
(() => {
  // ====== i18n ======
  const i18n = {
    uz: {
      app:'Drone Show Smeta • Web',
      inputs:'Kiritmalar',
      v4:'Dron V4 (dona)',
      y2:'Dron Y2 (dona)',
      fig:'Figuralar soni',
      price:'Narx (USD / dron / figura)',
      refresh:'CBU kursini yangilash',
      clear:'Tozalash',
      rate:'Kurs: USD→UZS:',
      logo:'GEO Innovation Centre',
      total_usd:'Jami (USD):',
      total_uzs:'Jami (UZS):',
      formula:'Formula: (V4 + Y2) × narx × figuralar.',
      fetching:'Kurs olinmoqda…',
      ok:'OK (yangilandi)',
      err_prefix:'Kurs olinmadi. Internetni tekshiring. Sabab:'
    },
    ru: {
      app:'Drone Show Smeta • Web',
      inputs:'Ввод данных',
      v4:'Дрон V4 (шт.)',
      y2:'Дрон Y2 (шт.)',
      fig:'Количество фигур',
      price:'Цена (USD / дрон / фигура)',
      refresh:'Обновить курс ЦБУ',
      clear:'Очистить',
      rate:'Курс: USD→UZS:',
      logo:'GEO Innovation Centre',
      total_usd:'Итого (USD):',
      total_uzs:'Итого (UZS):',
      formula:'Формула: (V4 + Y2) × цена × фигуры.',
      fetching:'Загружаем курс…',
      ok:'OK (обновлено)',
      err_prefix:'Курс не получен. Проверьте интернет. Причина:'
    },
    en: {
      app:'Drone Show Smeta • Web',
      inputs:'Inputs',
      v4:'Drone V4 (qty)',
      y2:'Drone Y2 (qty)',
      fig:'Figures count',
      price:'Price (USD / drone / figure)',
      refresh:'Refresh CBU rate',
      clear:'Clear',
      rate:'Rate: USD→UZS:',
      logo:'GEO Innovation Centre',
      total_usd:'Total (USD):',
      total_uzs:'Total (UZS):',
      formula:'Formula: (V4 + Y2) × price × figures.',
      fetching:'Fetching rate…',
      ok:'OK (updated)',
      err_prefix:'Failed to get rate. Check internet. Reason:'
    }
  };

  const el = id => document.getElementById(id);
  const v4 = el('v4'), y2 = el('y2'), fig = el('fig'), price = el('price');
  const usdTotal = el('usdTotal'), uzsTotal = el('uzsTotal');
  const rateLbl = el('rateLbl'), statusLbl = el('statusLbl');
  const btnRefresh = el('btnRefresh'), btnClear = el('btnClear');
  const langSel = el('langSel');

  const fUSD = new Intl.NumberFormat('en-US', { style:'currency', currency:'USD' });
  const fUZS = new Intl.NumberFormat('uz-UZ', { style:'currency', currency:'UZS', maximumFractionDigits:0 });

  // ====== Til holati ======
  function applyLang(lang) {
    const t = i18n[lang] || i18n.uz;
    el('t_app').textContent = t.app;
    el('t_inputs').textContent = t.inputs;
    el('t_v4').textContent = t.v4;
    el('t_y2').textContent = t.y2;
    el('t_fig').textContent = t.fig;
    el('t_price').textContent = t.price;
    btnRefresh.textContent = t.refresh;
    btnClear.textContent = t.clear;
    rateLbl.textContent = `${t.rate} ${rate ? rate.toLocaleString('uz-UZ',{maximumFractionDigits:2}) : '—'}`;
    el('t_logoText').textContent = t.logo;
    el('t_total_usd').textContent = t.total_usd;
    el('t_total_uzs').textContent = t.total_uzs;
    el('t_formula').textContent = t.formula;
    recalc();
  }

  langSel.value = localStorage.getItem('dss_lang') || 'uz';
  applyLang(langSel.value);
  langSel.addEventListener('change', () => {
    localStorage.setItem('dss_lang', langSel.value);
    applyLang(langSel.value);
  });

  // ====== Hisob ======
  let rate = Number(localStorage.getItem('cbu_rate_usd_uzs') || 0);

  function recalc() {
    const v = Number(v4.value||0) + Number(y2.value||0);
    const p = Number(price.value||0);
    const n = Number(fig.value||0);
    const totalUsd = v * p * n;
    usdTotal.textContent = fUSD.format(totalUsd || 0);
    const t = i18n[langSel.value] || i18n.uz;
    if (rate) {
      const totalUzs = totalUsd * rate;
      uzsTotal.textContent = fUZS.format(totalUzs||0);
      rateLbl.textContent = `${t.rate} ${rate.toLocaleString('uz-UZ',{maximumFractionDigits:2})}`;
    } else {
      uzsTotal.textContent = (langSel.value==='ru') ? '0 сум' : (langSel.value==='en' ? '0 UZS' : '0 so‘m');
      rateLbl.textContent = `${t.rate} —`;
    }
  }
  [v4, y2, fig, price].forEach(inp => inp.addEventListener('input', recalc));

  // ====== CBU kursi (keshdan qochish, timeout, retry) ======
  async function fetchWithTimeout(url, ms=8000, opts={}) {
    const ctrl = new AbortController();
    const t = setTimeout(()=>ctrl.abort(), ms);
    try {
      return await fetch(url, { ...opts, signal: ctrl.signal });
    } finally {
      clearTimeout(t);
    }
  }

  async function fetchCbuRate() {
    const t = i18n[langSel.value] || i18n.uz;
    statusLbl.textContent = t.fetching; statusLbl.className='status';

    const url = "https://cbu.uz/uz/arkhiv-kursov-valyut/json/USD/";
    const opts = { headers:{'Accept':'application/json'}, cache:'no-store' };

    try {
      let res = await fetchWithTimeout(url, 8000, opts);
      if (!res.ok) throw new Error("HTTP "+res.status);
      let data = await res.json();
      if (!Array.isArray(data) || !data.length || !data.at(-1)?.Rate) throw new Error("No UZS");
      rate = parseFloat(String(data.at(-1).Rate).replace(",", "."));
      if (!Number.isFinite(rate)) throw new Error("Bad rate");

      localStorage.setItem('cbu_rate_usd_uzs', String(rate));
      statusLbl.textContent = t.ok; statusLbl.className='status ok';
      recalc();
    } catch (e) {
      // Bitta qayta urinish
      try {
        let res = await fetchWithTimeout(url, 8000, opts);
        if (!res.ok) throw new Error("HTTP "+res.status);
        let data = await res.json();
        rate = parseFloat(String(data.at(-1).Rate).replace(",", "."));
        localStorage.setItem('cbu_rate_usd_uzs', String(rate));
        statusLbl.textContent = t.ok; statusLbl.className='status ok';
        recalc();
      } catch (e2) {
        statusLbl.textContent = `${t.err_prefix} ${e2.message}`;
        statusLbl.className='status err';
        recalc();
      }
    }
  }

  btnRefresh.addEventListener('click', (ev)=>{ ev.preventDefault(); fetchCbuRate(); });
  btnClear.addEventListener('click', (ev)=>{ ev.preventDefault(); v4.value=0;y2.value=0;fig.value=1;price.value=0; recalc(); });

  // Boshlanish
  recalc();

  // Service worker (ixtiyoriy, lekin GitHub Pages uchun foydali)
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./sw.js?v=104').catch(()=>{});
  }
})();
</script>
</body>
</html>
