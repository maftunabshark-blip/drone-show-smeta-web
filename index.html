<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Drone Show Smeta • Web</title>

  <!-- Faviconlar (ixtiyoriy) -->
  <link rel="icon" href="./apple-touch-icon.ico">
  <link rel="apple-touch-icon" href="./apple-touch-icon.png">

  <style>
    :root { --bg:#0f172a10; --card:#ffffff; --muted:#64748b; --brand:#1f2937; }
    *{box-sizing:border-box} body{margin:0;font:16px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Arial}
    .wrap{max-width:1100px;margin:40px auto;padding:0 16px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:28px}
    .card{background:var(--card);border-radius:18px;box-shadow:0 10px 30px #0f172a18;padding:28px}
    h1{margin:0 0 16px 0;font-size:28px}
    label{display:block;font-size:14px;color:var(--muted);margin:14px 0 6px}
    input{width:100%;padding:12px 14px;border:1px solid #e5e7eb;border-radius:10px;font-size:16px}
    .row{display:flex;gap:12px;margin-top:16px}
    button{padding:12px 16px;border:0;border-radius:12px;background:#26334d;color:#fff;font-weight:600;cursor:pointer}
    button.secondary{background:#0f172a20;color:#0f172a}
    .note{margin-top:12px;color:#6b7280;font-size:14px}
    .total h2{font-size:42px;margin:8px 0}
    .muted{color:var(--muted)}
    .brand{color:var(--brand)}
    .logoBox{margin-top:18px;display:flex;align-items:center;gap:10px}
    .logoBox img{height:54px;width:auto;display:block}
    .status{margin-top:10px;font-size:14px}
    .ok{color:#15803d}.err{color:#b91c1c}
    @media (max-width:860px){ .grid{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Drone Show Smeta • <span class="muted">Web</span> <span id="busy" class="muted">— Yuklanmoqda…</span></h1>

    <div class="grid">
      <!-- Chap panel -->
      <div class="card">
        <h2 class="brand" style="margin:0 0 8px">Kiritmalar</h2>

        <label for="v4">Dron V4 (dona)</label>
        <input id="v4" type="number" min="0" step="1" value="1000">

        <label for="y2">Dron Y2 (dona)</label>
        <input id="y2" type="number" min="0" step="1" value="100">

        <label for="fig">Figuralar soni</label>
        <input id="fig" type="number" min="1" step="1" value="1">

        <label for="price">Narx (USD / dron / figura)</label>
        <input id="price" type="number" min="0" step="0.01" value="70">

        <div class="row">
          <button id="btnRefresh">CBU kursini yangilash</button>
          <button id="btnClear" class="secondary">Tozalash</button>
        </div>

        <div class="logoBox">
          <img src="./icons/geo_logo.png" alt="GEO Innovation Centre logotipi">
          <div class="muted">GEO Innovation Centre</div>
        </div>

        <div class="note" id="rateLbl">Kurs: USD→UZS: —</div>
        <div class="status" id="statusLbl"></div>
      </div>

      <!-- O‘ng panel -->
      <div class="card total">
        <h2 class="brand" style="margin:0">Jami (USD):</h2>
        <h2 id="usdTotal">$ 0.00</h2>
        <hr style="border:none;border-top:1px solid #e5e7eb;margin:18px 0">
        <h2 class="brand" style="margin:0">Jami (UZS):</h2>
        <h2 id="uzsTotal">0 so‘m</h2>
        <div class="note">Formula: (V4 + Y2) × narx × figuralar.</div>
      </div>
    </div>
  </div>

<script>
(() => {
  const el = id => document.getElementById(id);
  const v4 = el('v4'), y2 = el('y2'), fig = el('fig'), price = el('price');
  const usdTotal = el('usdTotal'), uzsTotal = el('uzsTotal');
  const rateLbl = el('rateLbl'), statusLbl = el('statusLbl'), busy = el('busy');
  const btnRefresh = el('btnRefresh'), btnClear = el('btnClear');

  // Valyuta formatlari
  const fUSD = new Intl.NumberFormat('en-US', { style:'currency', currency:'USD' });
  const fUZS = new Intl.NumberFormat('uz-UZ', { style:'currency', currency:'UZS', maximumFractionDigits:0 });

  let rate = Number(localStorage.getItem('cbu_rate_usd_uzs') || 0);

  function recalc() {
    const v = Number(v4.value||0) + Number(y2.value||0);
    const p = Number(price.value||0);
    const n = Number(fig.value||0);
    const totalUsd = v * p * n;
    const totalUzs = totalUsd * (rate||0);
    usdTotal.textContent = fUSD.format(totalUsd || 0);
    uzsTotal.textContent = rate ? fUZS.format(totalUzs||0) : "0 so‘m";
  }

  async function fetchCbuRate() {
    statusLbl.textContent = "Kurs olinmoqda…";
    statusLbl.className = "status";
    try {
      // CBU HTTPS JSON, keshni chetlash: no-store. (GitHub Pages + SW muammosidan qochish uchun)
      const url = "https://cbu.uz/uz/arkhiv-kursov-valyut/json/USD/";
      const res = await fetch(url, { headers:{'Accept':'application/json'}, cache:'no-store' });
      if (!res.ok) throw new Error("HTTP " + res.status);
      const data = await res.json();
      if (!Array.isArray(data) || !data.length || !data.at(-1).Rate) throw new Error("No UZS");
      rate = parseFloat(String(data.at(-1).Rate).replace(",", "."));
      if (!Number.isFinite(rate)) throw new Error("Bad rate");
      localStorage.setItem('cbu_rate_usd_uzs', String(rate));
      rateLbl.textContent = `Kurs: USD→UZS: ${rate.toLocaleString('uz-UZ', {maximumFractionDigits:2})}`;
      statusLbl.textContent = "OK (yangilandi)";
      statusLbl.className = "status ok";
      recalc();
    } catch (e) {
      // Fallback: localStorage bor bo‘lsa, shuni ishlatamiz
      if (rate) {
